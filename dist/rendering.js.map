{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","columns","panel","tooltipEle","find","captionEle","events","on","render","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","showError","errorText","noData","text","show","hide","addZoom","svg","svgWrapper","select","call","d3","zoom","scale","event","transform","k","translate","x","y","attr","d","i","y_plus_5","getCombineMethodParams","value1","value2","addNetworkChart","width","color","scaleOrdinal","schemeCategory10","filter","filterable","captions","captionsUpdate","selectAll","exit","remove","captionsEnter","enter","append","merge","tooltip","style","showTooltip","transition","duration","html","length","pageX","pageY","hideTooltip","linkData","nodesData","combine","active","reduce","all","push","id","source","target","value","allSources","allTargets","forEach","initHash","combineMethod","method","relations","currentRel","sourceFromTarget","param","relation1","relation2","linkUpdate","Math","log","maxValueLogged","max","group","uniqBy","nodeUpdate","nodeEnter","drag","dragstarted","dragged","dragended","simulation","forceSimulation","force","forceLink","strength","forceManyBody","forceCenter","nodes","ticked","links","alphaTarget","restart","fx","fy","hash","key","_error","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\n//import * as d3 from 'd3';\n//import {event as currentEvent} from './d3-selection';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data,columns, panel;\n  var tooltipEle = elem.find('.tooltip');\n  var captionEle = elem.find('.caption');\n\n  elem = elem.find('.networkchart-panel');\n\n\n  ctrl.events.on('render', function() {\n    render();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n\n  function showError(errorText) {\n    var noData = elem.find(\".no-data\");\n    if(errorText){\n      noData.text(errorText);\n      noData.show();\n    }\n    else\n      noData.hide();\n  }\n\n  function addZoom(svg){\n    var svgWrapper = svg.select('.svg-wrapper');\n\n    svg.call(d3.zoom().on('zoom', function() {\n\n      var scale = d3.event.transform.k,\n      translate = [d3.event.transform.x, d3.event.transform.y];\n\n       svgWrapper.attr('transform', 'translate(' + translate[0] + ', ' + translate[1] + ') scale(' + scale + ')');\n   }));\n  }\n\n\n  function y(d,i){\n    return 25 * (i+1)\n  }\n\n  function y_plus_5(d,i){\n    return y(d,i) + 5\n  }\n\n  function getCombineMethodParams(value1, value2){\n    //TODO check the method and arrange the parameters\n    return [value1, value2];\n  }\n\n  function addNetworkChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var color = d3.scaleOrdinal(d3.schemeCategory10);\n\n    \n    //************************ Add Caption Colors *************************/\n    \n    var columns = _.filter(ctrl.columns, e => e.filterable)\n\n    var captions = d3.select(captionEle[0]);\n\n    var captionsUpdate = captions.selectAll(\"g\")\n                        .data(columns, d => d.text);\n\n\n    // EXIT\n    // Remove old elements as needed.\n    captionsUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var captionsEnter = captionsUpdate.enter()\n                        .append(\"g\");\n\n\n    captionsEnter\n      .append(\"circle\")\n      .attr(\"r\", 10)\n      .attr(\"fill\", (d,i) => color(i)  )\n      .attr(\"cx\", 15)\n      .attr(\"cy\", y)\n\n\n    captionsEnter\n      .append(\"text\")\n      .attr(\"fill\", \"white\")\n      .attr(\"x\", 25)\n      .attr(\"y\", y_plus_5);\n\n    \n    // ENTER + UPDATE\n    captionsUpdate.merge(captionsEnter)\n      .selectAll('text')\n      .text(d => d.text);\n\n\n\n    //************************ Tooltips *************************/\n\n    var tooltip = d3.select(tooltipEle[0])\n                  .style(\"opacity\", 0);\n\n\n    function showTooltip(d) {    \n      tooltip.transition()\n          .duration(200)\n          .style(\"opacity\", .8);\n\n      tooltip.html(d.tooltip)  \n          .style(\"width\",  (d.tooltip.length * 7) + \"px\")\n          .style(\"left\",  (d3.event.pageX) + \"px\")   \n          .style(\"top\",   (d3.event.pageY - 28) + \"px\")\n      }\n\n\n      function hideTooltip(d) {\n          tooltip.transition()    \n              .duration(500)    \n              .style(\"opacity\", 0); \n      }\n\n\n    //************************ Main Graph *************************/\n  \n    var svg = d3.select(elem[0]);\n\n    addZoom(svg);\n\n\n    //************************ Links between nodes *************************/\n    var linkData = [];\n    var nodesData = [];\n\n    if(!ctrl.panel.combine.active){\n     linkData = _.reduce(data, (all,d) => {\n\n      //No value\n      if(!d[2])\n        return all;\n\n          all.push({\n              id: d[0] + d[1], \n              source: d[0],\n              target: d[1],\n              value:  d[2],\n              tooltip: d[0]+ ' <=> ' + d[1] + '<br>' + d[2]\n            });\n        return all;\n      }\n      , []);\n    }\n    else\n    {\n      var allSources= {};\n      var allTargets= {};\n\n      _.forEach(data, d => {\n        //No value\n        if(!d[2])\n          return ;\n\n        var source = d[0];\n        var target = d[1];\n\n        initHash(allSources, source);\n        initHash(allTargets, target);\n\n        allSources[source][target] = d[2];\n        allTargets[target][source] = d[2];\n      });\n\n      var combineMethod = _[ctrl.panel.combine.method];\n\n      var relations = {};\n\n      for (var source in allSources) {\n\n        initHash(relations,source);\n        var currentRel = relations[source];\n\n        for (var target in allSources[source]) {\n\n          var value = allSources[source][target];\n\n          for (var sourceFromTarget in allTargets[target]) {\n\n            //Already calculated at the other end\n            if(relations[sourceFromTarget]) continue;\n\n            if(!currentRel[sourceFromTarget]) currentRel[sourceFromTarget] = 0;\n\n            var param = getCombineMethodParams(value , allTargets[target][sourceFromTarget]);\n            currentRel[sourceFromTarget] += combineMethod(param);\n          }\n        }\n      }\n\n      for (var relation1 in relations) {\n        for (var relation2 in relations[relation1]) {\n          var value = relations[relation1][relation2];\n\n          linkData.push({\n                id: relation1 + relation2, \n                source: relation1,\n                target: relation2,\n                value:  value,\n                tooltip: relation1+ ' <=> ' + relation2 + '<br>' + value\n              });\n\n          nodesData.push({\n            id: relation1 ,\n            tooltip: relation1\n          });\n\n          nodesData.push({\n            id: relation2 ,\n            tooltip: relation2\n          });\n\n        }\n      }\n    }\n\n\n    var linkUpdate = svg.select(\".links\")\n                    .selectAll(\"line\")\n                    .data(linkData, d => d.id);\n\n    // EXIT\n    // Remove old elements as needed.\n    linkUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var enter = linkUpdate.enter().append(\"line\")\n                .on(\"mouseover\", showTooltip)\n                .on(\"mouseout\", hideTooltip)\n\n    /*\n    enter    \n      .append(\"title\")\n      .text(d => d.id)\n    */\n\n    // ENTER + UPDATE\n    linkUpdate =linkUpdate.merge(enter)\n                //.selectAll(\"line\")\n                .attr(\"stroke-width\", d => Math.log(d.value) );\n\n\n    var maxValueLogged = _.reduce(linkData, (max, d) =>{\n      var log = Math.log(d.value);\n      if(log > max)\n        return log;\n\n      return max;\n    },0);\n\n    //************************ NODES *************************/\n\n    if(!ctrl.panel.combine.active)\n      nodesData = _.reduce(data, (all,d) => {\n        if(!d[2])\n          return all;\n\n          for(var i=0; i < d.length-1 ; i++)\n            all.push({\n              id: d[i], \n              group: i,\n              tooltip: d[i]\n            }); //columns[i].text\n\n          return all;\n        }\n        , []);\n\n    nodesData = _.uniqBy(nodesData, d => d.id);\n\n\n    var nodeUpdate = svg.select(\".nodes\")\n                    .selectAll('circle')\n                    .data(nodesData, d => d.id + '-node');\n\n    // EXIT\n    // Remove old elements as needed.\n    nodeUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var nodeEnter = nodeUpdate.enter().append(\"circle\")\n                    .attr(\"fill\", d => d.group ? color(d.group) : color(0) )\n                    .on(\"mouseover\", showTooltip)\n                    .on(\"mouseout\", hideTooltip)\n                    .call(d3.drag()\n                      .on(\"start\", dragstarted)\n                      .on(\"drag\", dragged)\n                      .on(\"end\", dragended));\n\n    /*                    \n    nodeEnter   \n        .append(\"title\")\n        .text(d => d.id);\n    */\n\n    // ENTER + UPDATE\n    nodeUpdate = nodeUpdate.merge(nodeEnter)\n      //.selectAll(\"circle\")\n      .attr(\"r\", 10); // TODO use cummulative value for this\n      \n\n    var simulation = d3.forceSimulation()\n      .force(\"link\", d3.forceLink()\n        .id(d => d.id) \n        .strength(d => { \n\n        if(!d.value)\n          return 0.01;\n\n        var strength = Math.log(d.value)/maxValueLogged;\n        if(strength < 0.01)\n          return 0.01;\n\n        return strength;\n        })\n      )\n      .force(\"charge\", d3.forceManyBody())\n      .force(\"center\", d3.forceCenter(width / 2, height / 2));\n\n    simulation\n      .nodes(nodesData)\n      .on(\"tick\", ticked);\n\n    simulation.force(\"link\")\n          .links(linkData);\n\n\n\n    function ticked() {\n      linkUpdate\n          .attr(\"x1\", function(d) { return d.source.x; })\n          .attr(\"y1\", function(d) { return d.source.y; })\n          .attr(\"x2\", function(d) { return d.target.x; })\n          .attr(\"y2\", function(d) { return d.target.y; });\n\n      nodeUpdate\n          .attr(\"cx\", function(d) { return d.x; })\n          .attr(\"cy\", function(d) { return d.y; });\n    }\n\n    function dragstarted(d) {\n      if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n      d.fx = d.x;\n      d.fy = d.y;\n    }\n\n    function dragged(d) {\n      d.fx = d3.event.x;\n      d.fy = d3.event.y;\n    }\n\n    function dragended(d) {\n      if (!d3.event.active) simulation.alphaTarget(0);\n      d.fx = null;\n      d.fy = null;\n    }\n\n    function initHash(hash,key) {\n      if (!hash[key])\n        hash[key]= {};\n    }\n\n  }\n\n\n  function render() {\n    data = ctrl.data;\n    columns = ctrl.columns;\n    panel = ctrl.panel;\n\n    if (setElementHeight())\n\n      if(ctrl._error || !data || !data.length)\n      {\n\n        showError(ctrl._error || \"No data points\");\n        \n        data = [];\n        addNetworkChart();\n\n      }\n      else\n      {\n        addNetworkChart();\n        showError(false);  \n      }\n\n    \n    ctrl.renderingCompleted();\n  }\n}\n\n"]}