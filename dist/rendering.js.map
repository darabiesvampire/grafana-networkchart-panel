{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","columns","panel","find","events","on","render","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","noDataPoints","display","noData","show","hide","addNetworkChart","width","svg","d3","select","color","scaleOrdinal","schemeCategory10","tooltip","style","linkData","reduce","all","d","push","id","source","target","value","linkUpdate","selectAll","exit","remove","enter","append","merge","attr","Math","log","nodesData","i","length","group","uniqBy","nodeUpdate","nodeEnter","call","drag","dragstarted","dragged","dragended","simulation","forceSimulation","force","forceLink","forceManyBody","forceCenter","nodes","ticked","links","x","y","event","active","alphaTarget","restart","fx","fy","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport * as d3 from 'd3';\n//import {event as currentEvent} from './d3-selection';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data,columns, panel;\n  elem = elem.find('.networkchart-panel');\n\n\n  ctrl.events.on('render', function() {\n    render();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n\n  function noDataPoints(display) {\n    var noData = elem.find(\".no-data\");\n    if(display)\n      noData.show();\n    else\n      noData.hide();\n  }\n\n\n  function addNetworkChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var svg = d3.select(elem[0]);\n    \n    var color = d3.scaleOrdinal(d3.schemeCategory10);\n\n\n    var tooltip = svg.select(\".tooltip\")\n                  .style(\"opacity\", 0);\n\n\n    //************************ Links between nodes *************************/\n\n    var linkData = _.reduce(data, (all,d) => {\n          all.push({\n              id: d[0]+ ' <-> ' + d[1], \n              source: d[0],\n              target: d[1],\n              value:  d[2]\n            });\n        return all;\n      }\n      , []);\n\n    var linkUpdate = svg.select(\".links\")\n                    .selectAll(\"line\")\n                    .data(linkData, d => d.id);\n\n    // EXIT\n    // Remove old elements as needed.\n    linkUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var enter = linkUpdate.enter().append(\"line\");\n\n    /*\n    enter    \n      .append(\"title\")\n      .text(d => d.id)\n    */\n\n    // ENTER + UPDATE\n    linkUpdate =linkUpdate.merge(enter)\n                //.selectAll(\"line\")\n                .attr(\"stroke-width\", d => Math.log(d.value) );\n\n\n    //************************ NODES *************************/\n\n\n    var nodesData = _.reduce(data, (all,d) => {\n\n        for(var i=0; i < d.length-1 ; i++)\n          all.push({id: d[i], group: i}); //columns[i].text\n\n        return all;\n      }\n      , []);\n\n    nodesData = _.uniqBy(nodesData, d => d.id);\n\n\n    var nodeUpdate = svg.select(\".nodes\")\n                    .selectAll('circle')\n                    .data(nodesData, d => d.id + '-node');\n\n    // EXIT\n    // Remove old elements as needed.\n    nodeUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var nodeEnter = nodeUpdate.enter().append(\"circle\")\n                    .attr(\"fill\", d => color(d.group))\n                    .call(d3.drag()\n                      .on(\"start\", dragstarted)\n                      .on(\"drag\", dragged)\n                      .on(\"end\", dragended));\n\n    /*                    \n    nodeEnter   \n        .append(\"title\")\n        .text(d => d.id);\n    */\n\n    // ENTER + UPDATE\n    nodeUpdate = nodeUpdate.merge(nodeEnter)\n      //.selectAll(\"circle\")\n      .attr(\"r\", 10); // TODO use cummulative value for this\n      \n\n    var simulation = d3.forceSimulation()\n      .force(\"link\", d3.forceLink().id(d => d.id) )\n      .force(\"charge\", d3.forceManyBody())\n      .force(\"center\", d3.forceCenter(width / 2, height / 2));\n\n    simulation\n      .nodes(nodesData)\n      .on(\"tick\", ticked);\n\n    simulation.force(\"link\")\n          .links(linkData);\n\n    function ticked() {\n      linkUpdate\n          .attr(\"x1\", function(d) { return d.source.x; })\n          .attr(\"y1\", function(d) { return d.source.y; })\n          .attr(\"x2\", function(d) { return d.target.x; })\n          .attr(\"y2\", function(d) { return d.target.y; });\n\n      nodeUpdate\n          .attr(\"cx\", function(d) { return d.x; })\n          .attr(\"cy\", function(d) { return d.y; });\n    }\n\n    function dragstarted(d) {\n      if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n      d.fx = d.x;\n      d.fy = d.y;\n    }\n\n    function dragged(d) {\n      d.fx = d3.event.x;\n      d.fy = d3.event.y;\n    }\n\n    function dragended(d) {\n      if (!d3.event.active) simulation.alphaTarget(0);\n      d.fx = null;\n      d.fy = null;\n    }\n\n  }\n\n\n  function render() {\n    data = ctrl.data;\n    columns = ctrl.columns;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      if (ctrl.data && ctrl.data.length){\n        addNetworkChart();\n        noDataPoints(false);\n      }\n      else \n        noDataPoints(true);\n    }\n    \n    ctrl.renderingCompleted();\n  }\n}\n\n"]}