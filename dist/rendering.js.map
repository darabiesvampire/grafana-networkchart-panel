{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","columns","panel","tooltipEle","find","events","on","render","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","showError","errorText","noData","text","show","hide","addZoom","svg","svgWrapper","select","call","d3","zoom","scale","event","transform","k","translate","x","y","attr","addNetworkChart","width","color","scaleOrdinal","schemeCategory10","tooltip","style","containerPositionFromTop","position","top","showTooltip","d","transition","duration","html","id","length","pageX","pageY","hideTooltip","linkData","reduce","all","push","source","target","value","linkUpdate","selectAll","exit","remove","enter","append","merge","Math","log","maxValueLogged","max","nodesData","i","group","uniqBy","nodeUpdate","nodeEnter","drag","dragstarted","dragged","dragended","simulation","forceSimulation","force","forceLink","strength","forceManyBody","forceCenter","nodes","ticked","links","active","alphaTarget","restart","fx","fy","_error","renderingCompleted"],"mappings":";;;;;;;AAIe,WAASA,IAAT,CAAcC,KAAd,EAAqBC,IAArB,EAA2BC,KAA3B,EAAkCC,IAAlC,EAAwC;AACrD,QAAIC,IAAJ,EAASC,OAAT,EAAkBC,KAAlB,EAAwBC,UAAxB;AACAA,iBAAaN,KAAKO,IAAL,CAAU,UAAV,CAAb;AACAP,WAAOA,KAAKO,IAAL,CAAU,qBAAV,CAAP;;AAGAL,SAAKM,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAW;AAClCC;AACD,KAFD;;AAIA,aAASC,gBAAT,GAA4B;AAC1B,UAAI;AACF,YAAIC,SAASV,KAAKU,MAAL,IAAeP,MAAMO,MAArB,IAA+BV,KAAKW,GAAL,CAASD,MAArD;AACA,YAAIE,EAAEC,QAAF,CAAWH,MAAX,CAAJ,EAAwB;AACtBA,mBAASI,SAASJ,OAAOK,OAAP,CAAe,IAAf,EAAqB,EAArB,CAAT,EAAmC,EAAnC,CAAT;AACD;;AAEDL,kBAAU,CAAV,CANE,CAMW;AACbA,kBAAUP,MAAMa,KAAN,GAAc,EAAd,GAAmB,CAA7B,CAPE,CAO8B;;AAEhClB,aAAKmB,GAAL,CAAS,QAAT,EAAmBP,SAAS,IAA5B;;AAEA,eAAO,IAAP;AACD,OAZD,CAYE,OAAMQ,CAAN,EAAS;AAAE;AACX,eAAO,KAAP;AACD;AACF;;AAGD,aAASC,SAAT,CAAmBC,SAAnB,EAA8B;AAC5B,UAAIC,SAASvB,KAAKO,IAAL,CAAU,UAAV,CAAb;AACA,UAAGe,SAAH,EAAa;AACXC,eAAOC,IAAP,CAAYF,SAAZ;AACAC,eAAOE,IAAP;AACD,OAHD,MAKEF,OAAOG,IAAP;AACH;;AAED,aAASC,OAAT,CAAiBC,GAAjB,EAAqB;AACnB,UAAIC,aAAaD,IAAIE,MAAJ,CAAW,cAAX,CAAjB;;AAEAF,UAAIG,IAAJ,CAASC,GAAGC,IAAH,GAAUxB,EAAV,CAAa,MAAb,EAAqB,YAAW;;AAEvC,YAAIyB,QAAQF,GAAGG,KAAH,CAASC,SAAT,CAAmBC,CAA/B;AAAA,YACAC,YAAY,CAACN,GAAGG,KAAH,CAASC,SAAT,CAAmBG,CAApB,EAAuBP,GAAGG,KAAH,CAASC,SAAT,CAAmBI,CAA1C,CADZ;;AAGCX,mBAAWY,IAAX,CAAgB,WAAhB,EAA6B,eAAeH,UAAU,CAAV,CAAf,GAA8B,IAA9B,GAAqCA,UAAU,CAAV,CAArC,GAAoD,UAApD,GAAiEJ,KAAjE,GAAyE,GAAtG;AACH,OANS,CAAT;AAOD;;AAED,aAASQ,eAAT,GAA2B;AACzB,UAAIC,QAAQ3C,KAAK2C,KAAL,EAAZ;AACA,UAAI/B,SAASZ,KAAKY,MAAL,EAAb;;AAEA,UAAIgB,MAAMI,GAAGF,MAAH,CAAU9B,KAAK,CAAL,CAAV,CAAV;;AAEA2B,cAAQC,GAAR;;AAGA,UAAIgB,QAAQZ,GAAGa,YAAH,CAAgBb,GAAGc,gBAAnB,CAAZ;;AAGA;AACA,UAAIC,UAAUf,GAAGF,MAAH,CAAUxB,WAAW,CAAX,CAAV,EACC0C,KADD,CACO,SADP,EACkB,CADlB,CAAd;;AAGA,UAAIC,2BAA4BjD,KAAKkD,QAAL,GAAgBC,GAAhD;;AAEA,eAASC,WAAT,CAAqBC,CAArB,EAAwB;AACtBN,gBAAQO,UAAR,GACKC,QADL,CACc,GADd,EAEKP,KAFL,CAEW,SAFX,EAEsB,EAFtB;;AAIAD,gBAAQS,IAAR,CAAaH,EAAEN,OAAf,EACKC,KADL,CACW,OADX,EACsBK,EAAEI,EAAF,CAAKC,MAAL,GAAc,CAAf,GAAoB,IADzC,EAEKV,KAFL,CAEW,MAFX,EAEqBhB,GAAGG,KAAH,CAASwB,KAAV,GAAmB,IAFvC,EAGKX,KAHL,CAGW,KAHX,EAGqBhB,GAAGG,KAAH,CAASyB,KAAT,GAAiBX,wBAAjB,GAA4C,EAA7C,GAAmD,IAHvE;AAIC;;AAGD,eAASY,WAAT,CAAqBR,CAArB,EAAwB;AACpBN,gBAAQO,UAAR,GACKC,QADL,CACc,GADd,EAEKP,KAFL,CAEW,SAFX,EAEsB,CAFtB;AAGH;;AAGH;;AAEA,UAAIc,WAAWhD,EAAEiD,MAAF,CAAS5D,IAAT,EAAe,UAAC6D,GAAD,EAAKX,CAAL,EAAW;;AAEvC;AACA,YAAG,CAACA,EAAE,CAAF,CAAJ,EACE,OAAOW,GAAP;;AAEEA,YAAIC,IAAJ,CAAS;AACLR,cAAIJ,EAAE,CAAF,IAAOA,EAAE,CAAF,CADN;AAELa,kBAAQb,EAAE,CAAF,CAFH;AAGLc,kBAAQd,EAAE,CAAF,CAHH;AAILe,iBAAQf,EAAE,CAAF,CAJH;AAKLN,mBAASM,EAAE,CAAF,IAAM,OAAN,GAAgBA,EAAE,CAAF,CAAhB,GAAuB,MAAvB,GAAgCA,EAAE,CAAF;AALpC,SAAT;AAOF,eAAOW,GAAP;AACD,OAdY,EAeX,EAfW,CAAf;;AAiBA,UAAIK,aAAazC,IAAIE,MAAJ,CAAW,QAAX,EACAwC,SADA,CACU,MADV,EAEAnE,IAFA,CAEK2D,QAFL,EAEe;AAAA,eAAKT,EAAEI,EAAP;AAAA,OAFf,CAAjB;;AAIA;AACA;AACAY,iBAAWE,IAAX,GAAkBC,MAAlB;;AAEA;AACA;AACA,UAAIC,QAAQJ,WAAWI,KAAX,GAAmBC,MAAnB,CAA0B,MAA1B,EACCjE,EADD,CACI,WADJ,EACiB2C,WADjB,EAEC3C,EAFD,CAEI,UAFJ,EAEgBoD,WAFhB,CAAZ;;AAIA;;;;;;AAMA;AACAQ,mBAAYA,WAAWM,KAAX,CAAiBF,KAAjB;AACA;AADA,OAEChC,IAFD,CAEM,cAFN,EAEsB;AAAA,eAAKmC,KAAKC,GAAL,CAASxB,EAAEe,KAAX,CAAL;AAAA,OAFtB,CAAZ;;AAKA,UAAIU,iBAAiBhE,EAAEiD,MAAF,CAASD,QAAT,EAAmB,UAACiB,GAAD,EAAM1B,CAAN,EAAW;AACjD,YAAIwB,MAAMD,KAAKC,GAAL,CAASxB,EAAEe,KAAX,CAAV;AACA,YAAGS,MAAME,GAAT,EACE,OAAOF,GAAP;;AAEF,eAAOE,GAAP;AACD,OANoB,EAMnB,CANmB,CAArB;;AAQA;;;AAGA,UAAIC,YAAYlE,EAAEiD,MAAF,CAAS5D,IAAT,EAAe,UAAC6D,GAAD,EAAKX,CAAL,EAAW;AACxC,YAAG,CAACA,EAAE,CAAF,CAAJ,EACE,OAAOW,GAAP;;AAEA,aAAI,IAAIiB,IAAE,CAAV,EAAaA,IAAI5B,EAAEK,MAAF,GAAS,CAA1B,EAA8BuB,GAA9B;AACEjB,cAAIC,IAAJ,CAAS;AACPR,gBAAIJ,EAAE4B,CAAF,CADG;AAEPC,mBAAOD,CAFA;AAGPlC,qBAASM,EAAE4B,CAAF;AAHF,WAAT;AADF,SAJsC,CAShC;;AAEN,eAAOjB,GAAP;AACD,OAZa,EAaZ,EAbY,CAAhB;;AAeAgB,kBAAYlE,EAAEqE,MAAF,CAASH,SAAT,EAAoB;AAAA,eAAK3B,EAAEI,EAAP;AAAA,OAApB,CAAZ;;AAGA,UAAI2B,aAAaxD,IAAIE,MAAJ,CAAW,QAAX,EACAwC,SADA,CACU,QADV,EAEAnE,IAFA,CAEK6E,SAFL,EAEgB;AAAA,eAAK3B,EAAEI,EAAF,GAAO,OAAZ;AAAA,OAFhB,CAAjB;;AAIA;AACA;AACA2B,iBAAWb,IAAX,GAAkBC,MAAlB;;AAEA;AACA;AACA,UAAIa,YAAYD,WAAWX,KAAX,GAAmBC,MAAnB,CAA0B,QAA1B,EACCjC,IADD,CACM,MADN,EACc;AAAA,eAAKG,MAAMS,EAAE6B,KAAR,CAAL;AAAA,OADd,EAECzE,EAFD,CAEI,WAFJ,EAEiB2C,WAFjB,EAGC3C,EAHD,CAGI,UAHJ,EAGgBoD,WAHhB,EAIC9B,IAJD,CAIMC,GAAGsD,IAAH,GACH7E,EADG,CACA,OADA,EACS8E,WADT,EAEH9E,EAFG,CAEA,MAFA,EAEQ+E,OAFR,EAGH/E,EAHG,CAGA,KAHA,EAGOgF,SAHP,CAJN,CAAhB;;AASA;;;;;;AAMA;AACAL,mBAAaA,WAAWT,KAAX,CAAiBU,SAAjB;AACX;AADW,OAEV5C,IAFU,CAEL,GAFK,EAEA,EAFA,CAAb,CAzIyB,CA2IP;;;AAGlB,UAAIiD,aAAa1D,GAAG2D,eAAH,GACdC,KADc,CACR,MADQ,EACA5D,GAAG6D,SAAH,GACZpC,EADY,CACT;AAAA,eAAKJ,EAAEI,EAAP;AAAA,OADS,EAEZqC,QAFY,CAEH,aAAK;;AAEf,YAAG,CAACzC,EAAEe,KAAN,EACE,OAAO,IAAP;;AAEF,YAAI0B,WAAWlB,KAAKC,GAAL,CAASxB,EAAEe,KAAX,IAAkBU,cAAjC;AACA,YAAGgB,WAAW,IAAd,EACE,OAAO,IAAP;;AAEF,eAAOA,QAAP;AACC,OAZY,CADA,EAedF,KAfc,CAeR,QAfQ,EAeE5D,GAAG+D,aAAH,EAfF,EAgBdH,KAhBc,CAgBR,QAhBQ,EAgBE5D,GAAGgE,WAAH,CAAerD,QAAQ,CAAvB,EAA0B/B,SAAS,CAAnC,CAhBF,CAAjB;;AAkBA8E,iBACGO,KADH,CACSjB,SADT,EAEGvE,EAFH,CAEM,MAFN,EAEcyF,MAFd;;AAIAR,iBAAWE,KAAX,CAAiB,MAAjB,EACOO,KADP,CACarC,QADb;;AAGA,eAASoC,MAAT,GAAkB;AAChB7B,mBACK5B,IADL,CACU,IADV,EACgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEa,MAAF,CAAS3B,CAAhB;AAAoB,SADlD,EAEKE,IAFL,CAEU,IAFV,EAEgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEa,MAAF,CAAS1B,CAAhB;AAAoB,SAFlD,EAGKC,IAHL,CAGU,IAHV,EAGgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEc,MAAF,CAAS5B,CAAhB;AAAoB,SAHlD,EAIKE,IAJL,CAIU,IAJV,EAIgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEc,MAAF,CAAS3B,CAAhB;AAAoB,SAJlD;;AAMA4C,mBACK3C,IADL,CACU,IADV,EACgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEd,CAAT;AAAa,SAD3C,EAEKE,IAFL,CAEU,IAFV,EAEgB,UAASY,CAAT,EAAY;AAAE,iBAAOA,EAAEb,CAAT;AAAa,SAF3C;AAGD;;AAED,eAAS+C,WAAT,CAAqBlC,CAArB,EAAwB;AACtB,YAAI,CAACrB,GAAGG,KAAH,CAASiE,MAAd,EAAsBV,WAAWW,WAAX,CAAuB,GAAvB,EAA4BC,OAA5B;AACtBjD,UAAEkD,EAAF,GAAOlD,EAAEd,CAAT;AACAc,UAAEmD,EAAF,GAAOnD,EAAEb,CAAT;AACD;;AAED,eAASgD,OAAT,CAAiBnC,CAAjB,EAAoB;AAClBA,UAAEkD,EAAF,GAAOvE,GAAGG,KAAH,CAASI,CAAhB;AACAc,UAAEmD,EAAF,GAAOxE,GAAGG,KAAH,CAASK,CAAhB;AACD;;AAED,eAASiD,SAAT,CAAmBpC,CAAnB,EAAsB;AACpB,YAAI,CAACrB,GAAGG,KAAH,CAASiE,MAAd,EAAsBV,WAAWW,WAAX,CAAuB,CAAvB;AACtBhD,UAAEkD,EAAF,GAAO,IAAP;AACAlD,UAAEmD,EAAF,GAAO,IAAP;AACD;AAEF;;AAGD,aAAS9F,MAAT,GAAkB;AAChBP,aAAOD,KAAKC,IAAZ;AACAC,gBAAUF,KAAKE,OAAf;AACAC,cAAQH,KAAKG,KAAb;;AAEA,UAAIM,kBAAJ,EAEE,IAAGT,KAAKuG,MAAL,IAAe,CAACtG,IAAhB,IAAwB,CAACA,KAAKuD,MAAjC,EACA;;AAEErC,kBAAUnB,KAAKuG,MAAL,IAAe,gBAAzB;;AAEAtG,eAAO,EAAP;AACAuC;AAED,OARD,MAUA;AACEA;AACArB,kBAAU,KAAV;AACD;;AAGHnB,WAAKwG,kBAAL;AACD;AACF;;qBAnRuB5G,I;;;;AAJjBgB,O","file":"rendering.js","sourcesContent":["import _ from 'lodash';\n//import * as d3 from 'd3';\n//import {event as currentEvent} from './d3-selection';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data,columns, panel,tooltipEle;\n  tooltipEle = elem.find('.tooltip');\n  elem = elem.find('.networkchart-panel');\n\n\n  ctrl.events.on('render', function() {\n    render();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n\n  function showError(errorText) {\n    var noData = elem.find(\".no-data\");\n    if(errorText){\n      noData.text(errorText);\n      noData.show();\n    }\n    else\n      noData.hide();\n  }\n\n  function addZoom(svg){\n    var svgWrapper = svg.select('.svg-wrapper');\n\n    svg.call(d3.zoom().on('zoom', function() {\n\n      var scale = d3.event.transform.k,\n      translate = [d3.event.transform.x, d3.event.transform.y];\n\n       svgWrapper.attr('transform', 'translate(' + translate[0] + ', ' + translate[1] + ') scale(' + scale + ')');\n   }));\n  }\n\n  function addNetworkChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var svg = d3.select(elem[0]);\n\n    addZoom(svg);\n\n    \n    var color = d3.scaleOrdinal(d3.schemeCategory10);\n\n\n    //************************ Tooltips *************************/\n    var tooltip = d3.select(tooltipEle[0])\n                  .style(\"opacity\", 0);\n\n    var containerPositionFromTop =  elem.position().top;\n\n    function showTooltip(d) {    \n      tooltip.transition()\n          .duration(200)\n          .style(\"opacity\", .9);\n\n      tooltip.html(d.tooltip)  \n          .style(\"width\",  (d.id.length * 7) + \"px\")\n          .style(\"left\",  (d3.event.pageX) + \"px\")   \n          .style(\"top\",   (d3.event.pageY - containerPositionFromTop - 30) + \"px\")\n      }\n\n\n      function hideTooltip(d) {   \n          tooltip.transition()    \n              .duration(500)    \n              .style(\"opacity\", 0); \n      }\n\n\n    //************************ Links between nodes *************************/\n\n    var linkData = _.reduce(data, (all,d) => {\n\n      //No value\n      if(!d[2])\n        return all;\n\n          all.push({\n              id: d[0] + d[1], \n              source: d[0],\n              target: d[1],\n              value:  d[2],\n              tooltip: d[0]+ ' <=> ' + d[1] + '<br>' + d[2]\n            });\n        return all;\n      }\n      , []);\n\n    var linkUpdate = svg.select(\".links\")\n                    .selectAll(\"line\")\n                    .data(linkData, d => d.id);\n\n    // EXIT\n    // Remove old elements as needed.\n    linkUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var enter = linkUpdate.enter().append(\"line\")\n                .on(\"mouseover\", showTooltip)\n                .on(\"mouseout\", hideTooltip)\n\n    /*\n    enter    \n      .append(\"title\")\n      .text(d => d.id)\n    */\n\n    // ENTER + UPDATE\n    linkUpdate =linkUpdate.merge(enter)\n                //.selectAll(\"line\")\n                .attr(\"stroke-width\", d => Math.log(d.value) );\n\n\n    var maxValueLogged = _.reduce(linkData, (max, d) =>{\n      var log = Math.log(d.value);\n      if(log > max)\n        return log;\n\n      return max;\n    },0);\n\n    //************************ NODES *************************/\n\n\n    var nodesData = _.reduce(data, (all,d) => {\n      if(!d[2])\n        return all;\n\n        for(var i=0; i < d.length-1 ; i++)\n          all.push({\n            id: d[i], \n            group: i,\n            tooltip: d[i]\n          }); //columns[i].text\n\n        return all;\n      }\n      , []);\n\n    nodesData = _.uniqBy(nodesData, d => d.id);\n\n\n    var nodeUpdate = svg.select(\".nodes\")\n                    .selectAll('circle')\n                    .data(nodesData, d => d.id + '-node');\n\n    // EXIT\n    // Remove old elements as needed.\n    nodeUpdate.exit().remove();\n\n    // ENTER\n    // Create new elements as needed.  \n    var nodeEnter = nodeUpdate.enter().append(\"circle\")\n                    .attr(\"fill\", d => color(d.group))\n                    .on(\"mouseover\", showTooltip)\n                    .on(\"mouseout\", hideTooltip)\n                    .call(d3.drag()\n                      .on(\"start\", dragstarted)\n                      .on(\"drag\", dragged)\n                      .on(\"end\", dragended));\n\n    /*                    \n    nodeEnter   \n        .append(\"title\")\n        .text(d => d.id);\n    */\n\n    // ENTER + UPDATE\n    nodeUpdate = nodeUpdate.merge(nodeEnter)\n      //.selectAll(\"circle\")\n      .attr(\"r\", 10); // TODO use cummulative value for this\n      \n\n    var simulation = d3.forceSimulation()\n      .force(\"link\", d3.forceLink()\n        .id(d => d.id) \n        .strength(d => { \n\n        if(!d.value)\n          return 0.01;\n\n        var strength = Math.log(d.value)/maxValueLogged;\n        if(strength < 0.01)\n          return 0.01;\n\n        return strength;\n        })\n      )\n      .force(\"charge\", d3.forceManyBody())\n      .force(\"center\", d3.forceCenter(width / 2, height / 2));\n\n    simulation\n      .nodes(nodesData)\n      .on(\"tick\", ticked);\n\n    simulation.force(\"link\")\n          .links(linkData);\n\n    function ticked() {\n      linkUpdate\n          .attr(\"x1\", function(d) { return d.source.x; })\n          .attr(\"y1\", function(d) { return d.source.y; })\n          .attr(\"x2\", function(d) { return d.target.x; })\n          .attr(\"y2\", function(d) { return d.target.y; });\n\n      nodeUpdate\n          .attr(\"cx\", function(d) { return d.x; })\n          .attr(\"cy\", function(d) { return d.y; });\n    }\n\n    function dragstarted(d) {\n      if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n      d.fx = d.x;\n      d.fy = d.y;\n    }\n\n    function dragged(d) {\n      d.fx = d3.event.x;\n      d.fy = d3.event.y;\n    }\n\n    function dragended(d) {\n      if (!d3.event.active) simulation.alphaTarget(0);\n      d.fx = null;\n      d.fy = null;\n    }\n\n  }\n\n\n  function render() {\n    data = ctrl.data;\n    columns = ctrl.columns;\n    panel = ctrl.panel;\n\n    if (setElementHeight())\n\n      if(ctrl._error || !data || !data.length)\n      {\n\n        showError(ctrl._error || \"No data points\");\n        \n        data = [];\n        addNetworkChart();\n\n      }\n      else\n      {\n        addNetworkChart();\n        showError(false);  \n      }\n\n    \n    ctrl.renderingCompleted();\n  }\n}\n\n"]}